<!doctype html>
<html>
  <head>
    <title>Add Case</title>
  </head>
  <body>
    <h2>Add Case (CNR)</h2>

    <input id="cnr" placeholder="Enter CNR" />
    <button onclick="start()">Start</button>

    <div id="captcha-area" style="display: none">
      <img id="captcha" />
      <input id="captchaInput" placeholder="Enter captcha" />
      <button onclick="submitCaptcha()">Submit</button>
    </div>

    <pre id="output"></pre>

    <script>
      let sessionId = null;

      async function start() {
        const cnr = document.getElementById("cnr").value;
        const res = await fetch("/cases/start?cnr=" + cnr, { method: "POST" });
        const data = await res.json();
        sessionId = data.session_id;

        document.getElementById("captcha").src = `/cases/captcha/${sessionId}`;
        document.getElementById("captcha-area").style.display = "block";
      }

      async function submitCaptcha() {
        const code = document.getElementById("captchaInput").value;
        const res = await fetch("/cases/submit", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            session_id: sessionId,
            captcha: code,
          }),
        });

        const data = await res.json();
        if (data.error) {
          alert("Invalid captcha, retrying");
          document.getElementById("captcha").src =
            `/cases/captcha/${sessionId}?t=${Date.now()}`;
          return;
        }

        const result = await fetch(`/cases/result/${sessionId}`);
        document.getElementById("output").innerText = JSON.stringify(
          await result.json(),
          null,
          2,
        );
      }
    </script>
  </body>
</html>
